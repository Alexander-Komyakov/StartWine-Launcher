#!/usr/bin/env python3

################################################___TRAY_353___##########################################################

from gettext import gettext as _
import os
import sys
import gi
gi.require_version('Gtk', '3.0')
from gi.repository import Gtk as gtk
from gi.repository import Gdk, GdkPixbuf, Gio, GLib, GObject, Pango
from pathlib import Path
import subprocess
from subprocess import *
import threading
import traceback
import logging
import argparse

link = f"{sys.argv[0]}/"
path_link = Path(link).parent
sw_scripts = f"{path_link}/"
sw_path = Path(sw_scripts).parent.parent
sw_shortcuts = Path(sw_path) / 'Shortcuts'

appind = 1

try:
    gi.require_version('AppIndicator3', '0.1')
    from gi.repository import AppIndicator3 as appindicator
except:
    try:
        gi.require_version('AyatanaAppIndicator3', '0.1')
        from gi.repository import AyatanaAppIndicator3 as appindicator
    except:
        appind = 0

APPINDICATOR_ID = 'StartWine'
DIRPATH = os.path.dirname(os.path.dirname(os.path.realpath(__file__)))

if appind == 1:
    def main():
        menu = gtk.Menu()
        indicator = appindicator.Indicator.new(APPINDICATOR_ID, DIRPATH+"/img/gui_icons/SW_Tray.png", appindicator.IndicatorCategory.APPLICATION_STATUS)
        indicator.set_status(appindicator.IndicatorStatus.ACTIVE)
        indicator.set_menu(tray_menu())
        gtk.main()
else:
    def on_popup(icon, button, time):
        menu = gtk.Menu()
        menu.popup(None, None, gtk.StatusIcon.position_menu, icon, button, time)

        def status_start_game(_):

            cmd = f"{sw_scripts}run.sh"
            subprocess.Popen(cmd, shell=True, start_new_session=True)

        def status_shortcuts(_):

            cmd = f"xdg-open '{sw_shortcuts}'"
            subprocess.Popen(cmd, shell=True)

        def status_kill(_):

            cmd = f"{sw_scripts}stop"
            subprocess.call(cmd, shell=True)

        def status_quit(_):

            gtk.main_quit()

        def game_name():

            cmd = f"sed 's/\//\\n/g' {sw_scripts}run.sh | sed 's/\"//g' | sed 's/\.exe//gi' | tail -n1"
            proc = subprocess.run(cmd, shell=True, stdout=subprocess.PIPE)
            out = str(proc.stdout[0:])
            out_name = str(out).replace('b\'', 'Open ').strip('n\'').strip('\ ').replace('start', 'StartWine').replace('%F', '')

            print(out_name)

            cmd_0 = gtk.MenuItem.new_with_label(str(out_name))
            cmd_0.connect('activate', status_start_game)
            menu.append(cmd_0)

        game_name()

        cmd_2 = gtk.MenuItem.new_with_label('Shortcuts')
        cmd_2.connect('activate', status_shortcuts)
        menu.append(cmd_2)

        cmd_2 = gtk.MenuItem.new_with_label('Stop')
        cmd_2.connect('activate', status_kill)
        menu.append(cmd_2)

        exittray = gtk.MenuItem.new_with_label('Exit')
        exittray.connect('activate', status_quit)
        menu.append(exittray)

        menu.show_all()
        return menu

    indicator = gtk.StatusIcon()
    indicator.set_from_file(DIRPATH+"/img/gui_icons/SW_Tray.png")
    indicator.connect('popup-menu', on_popup)
    gtk.main()

##############################################___APPINDOCATOR3___:

def tray_menu():

    menu = gtk.Menu()

####################   GAME_NAME___:

    def game_name():

        cmd = f"sed 's/\//\\n/g' {sw_scripts}run.sh | sed 's/\"//g' | sed 's/\.exe//gi' | tail -n1"
        proc = subprocess.run(cmd, shell=True, stdout=subprocess.PIPE)
        out = str(proc.stdout[0:])
        out_name = str(out).replace('b\'', 'Open ').strip('n\'').strip('\ ').replace('start', 'StartWine').replace('%F', '')

        print(out_name)

        cmd_0 = gtk.MenuItem.new_with_label(str(out_name))
        cmd_0.connect('activate', start_game)
        menu.append(cmd_0)

    game_name()

    cmd_1 = gtk.MenuItem.new_with_label('Shortcuts')
    cmd_1.connect('activate', shortcuts)
    menu.append(cmd_1)

    cmd_2 = gtk.MenuItem.new_with_label('Stop')
    cmd_2.connect('activate', kill)
    menu.append(cmd_2)

    exittray = gtk.MenuItem.new_with_label('Exit')
    exittray.connect('activate', quit)
    menu.append(exittray)

    menu.show_all()
    return menu

##################___START_GAME___:

def start_game(_):

    cmd = f"{sw_scripts}run.sh"
    subprocess.Popen(cmd, shell=True, start_new_session=True)

#################___SHORTCUTS___:

def shortcuts(_):

    cmd = f"xdg-open '{sw_shortcuts}'"
    subprocess.Popen(cmd, shell=True)

############___STOP___:

def kill(_):

    cmd = f"{sw_scripts}stop"
    subprocess.call(cmd, shell=True)

############___EXIT___:

def quit(_):

    gtk.main_quit()

try:
    if __name__ == "__main__":
        main()
except:
    print('___exit_tray___')


